<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Manevi Bilgi Oyunu ðŸŒ™</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Font: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1"></script>
    
    <style>
        /* --------------------------------------------
           PASTEL, AÃ‡IK, GÃ–ZÃœ YORMAYAN RENK PALETÄ° 
           -------------------------------------------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(145deg, #fbe9f0 0%, #e0f2e6 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            max-width: 900px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 48px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.05), 0 5px 15px rgba(0,0,0,0.03);
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        /* ÃœST BÄ°LGÄ° PANELÄ° */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .score-box, .level-box {
            background: white;
            padding: 12px 25px;
            border-radius: 40px;
            box-shadow: 0 6px 0 #cbd5e0;
            border: 1px solid #cbd5e0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2d3e50;
            font-size: 1.2rem;
        }

        .score-box i, .level-box i {
            color: #ff9f1c;
            font-size: 1.4rem;
        }

        /* SEVÄ°YE KUTULARI (KAYDIRILABÄ°LÄ°R) */
        .levels-wrapper {
            overflow-x: auto;
            margin-bottom: 20px;
            padding-bottom: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .levels-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            justify-content: flex-start;
            background: rgba(255,255,255,0.4);
            padding: 20px;
            border-radius: 60px;
            min-width: min-content;
        }

        .level-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            font-size: 1.4rem;
            color: #2d3e50;
            box-shadow: 0 6px 0 #b0c4ce;
            border: 2px solid #ffe9e9;
            transition: all 0.1s ease;
            position: relative;
            flex-shrink: 0;
        }

        .level-badge.active {
            background: #b5e6c3;
            box-shadow: 0 6px 0 #6b9e7a;
            color: #1e3a2f;
            border-color: #a5d6b7;
        }

        .level-badge.locked {
            background: #e0e0e0;
            box-shadow: 0 6px 0 #adadad;
            color: #7e7e7e;
            border-color: #ccc;
            opacity: 0.8;
        }

        .level-badge.locked i {
            font-size: 1.6rem;
            color: #8b8b8b;
        }

        .level-badge:not(.locked):hover {
            transform: scale(1.05);
            cursor: pointer;
            background: #ffe5a3;
        }

        /* SORU KARTI */
        .question-card {
            background: white;
            border-radius: 32px;
            padding: 35px 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 0 #e2e8f0;
            border: 2px solid #edf2f7;
        }

        .question-text {
            font-size: 1.7rem;
            font-weight: 600;
            color: #2d3e50;
            line-height: 1.4;
            margin-bottom: 30px;
            word-break: break-word;
        }

        /* ÅžIKLAR */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .option-btn {
            background: #fff6e6;
            border: 3px solid #ffdab9;
            border-radius: 100px;
            padding: 18px 12px;
            font-size: 1.2rem;
            font-weight: 500;
            color: #3a4e5e;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.15s;
            box-shadow: 0 7px 0 #e6c4a8;
            cursor: pointer;
            text-align: left;
            word-break: break-word;
        }

        .option-btn:hover {
            background: #ffe8d6;
            transform: translateY(-2px);
            box-shadow: 0 9px 0 #e6c4a8;
        }

        .option-btn.disabled {
            pointer-events: none;
            opacity: 0.7;
            filter: grayscale(0.3);
        }

        .option-btn.correct {
            background: #c8e6c9;
            border-color: #81c784;
            box-shadow: 0 7px 0 #519657;
            color: #1e3a2f;
        }

        .option-btn.wrong {
            background: #ffcdd2;
            border-color: #e57373;
            box-shadow: 0 7px 0 #b71c1c;
            color: #711515;
        }

        /* Ä°LERÄ° BUTONU */
        .next-btn {
            background: #b2d8d8;
            border: none;
            border-radius: 60px;
            padding: 18px 40px;
            font-size: 1.4rem;
            font-weight: 600;
            color: #1e4a4a;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px auto 5px;
            width: fit-content;
            box-shadow: 0 10px 0 #6b9e9e;
            transition: all 0.1s;
            cursor: pointer;
            border: 2px solid #c0e0e0;
        }

        .next-btn.active {
            background: #ffe69b;
            box-shadow: 0 10px 0 #d4a373;
            color: #5e4b3c;
        }

        .next-btn.active:hover {
            transform: translateY(-3px);
            box-shadow: 0 13px 0 #d4a373;
        }

        .next-btn.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* BÄ°LDÄ°RÄ°M (toast) */
        .toast-message {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: #2d3e50;
            padding: 14px 30px;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            border: 2px solid #ffe0b0;
            backdrop-filter: blur(4px);
            animation: slideDown 0.3s;
        }

        .toast-success {
            background: #d4edda;
            border-color: #a3d0b1;
            color: #0b5e42;
        }

        .toast-info {
            background: #fff3cd;
            border-color: #ffe69b;
            color: #856404;
        }

        @keyframes slideDown {
            from { top: -50px; opacity: 0; }
            to { top: 30px; opacity: 1; }
        }

        /* OYUN BÄ°TTÄ° MODAL */
        .game-over-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            visibility: hidden;
            opacity: 0;
            transition: 0.2s;
        }

        .game-over-modal.active {
            visibility: visible;
            opacity: 1;
        }

        .game-over-card {
            background: white;
            border-radius: 48px;
            padding: 40px;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 25px 0 #ffe0b5;
            border: 3px solid #ffe8d9;
        }

        .game-over-card h2 {
            font-size: 2.2rem;
            color: #b34180;
            margin-bottom: 15px;
        }

        .game-over-card p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: #4a4e6b;
        }

        .restart-btn {
            background: #ffb7b7;
            border: none;
            border-radius: 50px;
            padding: 16px 35px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #631e1e;
            box-shadow: 0 9px 0 #b47272;
            cursor: pointer;
            transition: 0.1s;
            display: inline-flex;
            gap: 10px;
        }

        .restart-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 0 #b47272;
        }

        /* --------------------------------------------
           RESPONSIVE Ä°YÄ°LEÅžTÄ°RMELER (Telefon/Tablet)
           -------------------------------------------- */
        @media (max-width: 768px) {
            .game-container { padding: 20px; }
            .score-box, .level-box { padding: 10px 18px; font-size: 1rem; }
            .score-box i, .level-box i { font-size: 1.2rem; }
            .question-text { font-size: 1.4rem; }
            .options-grid { gap: 15px; }
            .option-btn { padding: 15px 10px; font-size: 1rem; }
            .next-btn { padding: 14px 30px; font-size: 1.2rem; }
            .level-badge { width: 55px; height: 55px; font-size: 1.3rem; }
            .game-over-card { padding: 30px; }
            .game-over-card h2 { font-size: 1.8rem; }
        }

        @media (max-width: 480px) {
            body { padding: 10px; }
            .game-container { padding: 15px; border-radius: 32px; }
            .header { flex-direction: column; align-items: stretch; }
            .score-box, .level-box { width: 100%; justify-content: center; }
            .question-card { padding: 20px 15px; }
            .question-text { font-size: 1.2rem; margin-bottom: 20px; }
            .options-grid { grid-template-columns: 1fr; gap: 12px; }
            .option-btn { padding: 14px 12px; font-size: 0.95rem; justify-content: flex-start; }
            .option-btn i { display: none; } /* ikonlarÄ± gizle, yer kalsÄ±n */
            .next-btn { width: 100%; padding: 14px 20px; font-size: 1.1rem; }
            .level-badge { width: 48px; height: 48px; font-size: 1.1rem; }
            .level-badge.locked i { font-size: 1.3rem; }
            .game-over-card { padding: 25px; }
            .game-over-card h2 { font-size: 1.6rem; }
            .game-over-card p { font-size: 1rem; }
            .restart-btn { padding: 12px 25px; font-size: 1.1rem; }
        }

        /* Ã§ok kÃ¼Ã§Ã¼k ekranlar iÃ§in ekstra */
        @media (max-width: 360px) {
            .question-text { font-size: 1.1rem; }
            .option-btn { font-size: 0.85rem; }
        }
    </style>
</head>
<body>

<div class="game-container">
    <!-- ÃœST PANEL: Puan ve Seviye -->
    <div class="header">
        <div class="score-box">
            <i class="fas fa-star"></i>
            <span id="scoreDisplay">0</span> Puan
        </div>
        <div class="level-box">
            <i class="fas fa-crown"></i>
            Seviye <span id="currentLevelDisplay">1</span>
        </div>
    </div>

    <!-- SEVÄ°YE GÃ–STERGE (KAYDIRILABÄ°LÄ°R) -->
    <div class="levels-wrapper">
        <div id="levelIndicators" class="levels-container">
            <!-- javascript ile doldurulacak -->
        </div>
    </div>

    <!-- SORU ALANI -->
    <div id="questionCard" class="question-card">
        <div id="questionText" class="question-text">
            Soru yÃ¼kleniyor...
        </div>
        <div id="optionsContainer" class="options-grid">
            <!-- ÅŸÄ±klar buraya -->
        </div>

        <!-- Ä°LERÄ° BUTONU (baÅŸlangÄ±Ã§ta pasif) -->
        <button id="nextButton" class="next-btn disabled">
            <i class="fas fa-arrow-right"></i> Ä°leri
        </button>
    </div>
</div>

<!-- OYUN BÄ°TTÄ° MODAL -->
<div id="gameOverModal" class="game-over-modal">
    <div class="game-over-card">
        <h2><i class="fas fa-heart-crack"></i> Oyun Bitti</h2>
        <p id="gameOverMessage">Ä°kinci hakkÄ±nda da yanlÄ±ÅŸ cevap verdin.</p>
        <button id="restartGameBtn" class="restart-btn">
            <i class="fas fa-rotate-left"></i> Seviyeyi Tekrarla
        </button>
    </div>
</div>

<!-- TOAST mesajlarÄ± iÃ§in container -->
<div id="toastContainer" style="position: fixed; top: 20px; left: 0; right: 0; pointer-events: none; z-index: 9999;"></div>

<script type="module">
    // ----------------------------------------------------
    // FIREBASE IMPORTLAR
    // ----------------------------------------------------
    import { db } from './firebase-core.js';
    import { 
        collection, getDocs, addDoc, query, orderBy, limit, doc, setDoc, getDoc 
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // ----------------------------------------------------
    // 1) FIRESTORE'DA SORULAR YOKSA Ã–RNEK SORULARI YÃœKLE
    // ----------------------------------------------------
    const QUESTIONS_COLLECTION = 'manevi_sorular';
    const SAMPLE_QUESTIONS = [
        // KUR'AN
        { bolum: 'Kur\'an', soru: 'Kur\'an-Ä± Kerim kaÃ§ cÃ¼zden oluÅŸur?', secenekler: ['28', '29', '30', '31'], dogru: 2, zorluk: 1 },
        { bolum: 'Kur\'an', soru: 'Hangi sure Kur\'an\'Ä±n kalbi olarak bilinir?', secenekler: ['Fatiha', 'Yasin', 'Rahman', 'MÃ¼lk'], dogru: 1, zorluk: 2 },
        { bolum: 'Kur\'an', soru: 'Kur\'an\'da adÄ± geÃ§en tek sahabe kimdir?', secenekler: ['Ebu Bekir', 'Ã–mer', 'Zeyd', 'Ãœsame'], dogru: 2, zorluk: 2 },
        { bolum: 'Kur\'an', soru: 'Kur\'an\'da en uzun sure hangisidir?', secenekler: ['Bakara', 'Ali Ä°mran', 'Nisa', 'Araf'], dogru: 0, zorluk: 1 },
        { bolum: 'Kur\'an', soru: 'Kur\'an-Ä± Kerim kaÃ§ yÄ±lda indirilmiÅŸtir?', secenekler: ['20 yÄ±l', '23 yÄ±l', '25 yÄ±l', '22 yÄ±l'], dogru: 1, zorluk: 2 },
        // NAMAZ
        { bolum: 'Namaz', soru: 'Sabah namazÄ±nÄ±n farzÄ± kaÃ§ rekattÄ±r?', secenekler: ['2', '3', '4', '1'], dogru: 0, zorluk: 1 },
        { bolum: 'Namaz', soru: 'Ã–ÄŸle namazÄ±nÄ±n sÃ¼nnetleri toplam kaÃ§ rekattÄ±r?', secenekler: ['6', '8', '10', '4'], dogru: 0, zorluk: 2 },
        { bolum: 'Namaz', soru: 'Cuma namazÄ±nÄ±n farzÄ± kaÃ§ rekattÄ±r?', secenekler: ['2', '4', '3', '1'], dogru: 0, zorluk: 2 },
        { bolum: 'Namaz', soru: 'AkÅŸam namazÄ±nÄ±n ilk sÃ¼nneti kaÃ§ rekattÄ±r?', secenekler: ['2', '3', '4', '1'], dogru: 0, zorluk: 2 },
        { bolum: 'Namaz', soru: 'Teravih namazÄ± hangi vaktin sÃ¼nnetidir?', secenekler: ['Ramazan', 'Bayram', 'Cuma', 'Kandil'], dogru: 0, zorluk: 1 },
        // PEYGAMBERLER
        { bolum: 'Peygamberler', soru: 'Hangi peygamber balÄ±k tarafÄ±ndan yutulmuÅŸtur?', secenekler: ['Musa', 'Yunus', 'Ä°sa', 'Yusuf'], dogru: 1, zorluk: 1 },
        { bolum: 'Peygamberler', soru: 'Ä°lk peygamber kimdir?', secenekler: ['Adem', 'Nuh', 'Ä°dris', 'Åžit'], dogru: 0, zorluk: 1 },
        { bolum: 'Peygamberler', soru: 'Kur\'an\'da en Ã§ok adÄ± geÃ§en peygamber kimdir?', secenekler: ['Musa', 'Ä°brahim', 'Nuh', 'Yusuf'], dogru: 0, zorluk: 2 },
        { bolum: 'Peygamberler', soru: 'Hangi peygamber ateÅŸe atÄ±lmÄ±ÅŸtÄ±r?', secenekler: ['Ä°smail', 'Ä°brahim', 'Musa', 'Yahya'], dogru: 1, zorluk: 1 },
        { bolum: 'Peygamberler', soru: 'Hangi peygamberin mucizesi Ã¶lÃ¼yÃ¼ diriltmektir?', secenekler: ['Ä°sa', 'Musa', 'Davud', 'SÃ¼leyman'], dogru: 0, zorluk: 2 },
    ];

    async function seedQuestionsIfNeeded() {
        try {
            const q = query(collection(db, QUESTIONS_COLLECTION), limit(1));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                console.log('Ã–rnek sorular yÃ¼kleniyor...');
                for (const q of SAMPLE_QUESTIONS) {
                    await addDoc(collection(db, QUESTIONS_COLLECTION), q);
                }
                console.log('Ã–rnek sorular eklendi.');
            }
        } catch (e) {
            console.error('Soru yÃ¼kleme hatasÄ±:', e);
        }
    }

    // ----------------------------------------------------
    // 2) OYUN DURUMU (LOCALSTORAGE)
    // ----------------------------------------------------
    let gameState = {
        maxUnlockedLevel: 1,       // En fazla ulaÅŸÄ±lmÄ±ÅŸ seviye (asla dÃ¼ÅŸmez)
        currentLevel: 1,
        currentQuestionIndexInLevel: 0,
        score: 0,
        earnedPointsForQuestion: {} // { "seviye_soruId": true }
    };

    const STORAGE_KEY = 'maneviOyunSave';

    function loadGameState() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                gameState = { ...gameState, ...parsed };
                if (!gameState.earnedPointsForQuestion) gameState.earnedPointsForQuestion = {};
            } catch (e) {}
        }
    }

    function saveGameState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
    }

    // ----------------------------------------------------
    // 3) DEÄžÄ°ÅžKENLER
    // ----------------------------------------------------
    let allQuestions = [];
    let currentLevelQuestions = [];
    let currentQuestion = null;
    let answered = false;
    let firstAttempt = true;
    let gameActive = true;
    let selectedOptionIndex = null;

    // ----------------------------------------------------
    // 4) DOM ELEMENTLERÄ°
    // ----------------------------------------------------
    const questionEl = document.getElementById('questionText');
    const optionsEl = document.getElementById('optionsContainer');
    const nextBtn = document.getElementById('nextButton');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const currentLevelDisplay = document.getElementById('currentLevelDisplay');
    const levelIndicators = document.getElementById('levelIndicators');
    const gameOverModal = document.getElementById('gameOverModal');
    const gameOverMessage = document.getElementById('gameOverMessage');
    const restartBtn = document.getElementById('restartGameBtn');

    // ----------------------------------------------------
    // 5) YARDIMCI FONKSÄ°YONLAR
    // ----------------------------------------------------
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-message ${type === 'success' ? 'toast-success' : 'toast-info'}`;
        toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-circle-check' : 'fa-circle-info'}"></i> ${message}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
    }

    function triggerConfetti() {
        confetti({ particleCount: 80, spread: 70, origin: { y: 0.6 } });
    }

    // Seviye gÃ¶stergelerini Ã§iz (sadece maxUnlockedLevel + 2 kadar)
    function renderLevelIndicators() {
        const maxLevel = gameState.maxUnlockedLevel;
        let html = '';
        for (let i = 1; i <= maxLevel + 2; i++) {
            if (i <= maxLevel) {
                html += `<div class="level-badge active" data-level="${i}">${i}</div>`;
            } else if (i === maxLevel + 1) {
                html += `<div class="level-badge locked" data-level="${i}"><i class="fas fa-lock"></i></div>`;
            } else {
                html += `<div class="level-badge locked" style="opacity:0.4;"><i class="fas fa-lock"></i></div>`;
            }
        }
        levelIndicators.innerHTML = html;

        // Aktif seviyelere tÄ±klanabilir Ã¶zellik ekle
        document.querySelectorAll('.level-badge.active').forEach(badge => {
            badge.addEventListener('click', () => {
                const lvl = parseInt(badge.dataset.level);
                if (lvl <= gameState.maxUnlockedLevel && lvl !== gameState.currentLevel) {
                    // seviye deÄŸiÅŸtir, sorularÄ± yÃ¼kle
                    gameState.currentLevel = lvl;
                    gameState.currentQuestionIndexInLevel = 0;
                    saveGameState();
                    loadLevelQuestions(lvl);
                    currentLevelDisplay.innerText = lvl;
                }
            });
        });
    }

    // Seviyeye gÃ¶re soru sayÄ±sÄ± (2,4,6,8...)
    function getQuestionCountForLevel(level) {
        return level * 2;
    }

    // Firestore'dan tÃ¼m sorularÄ± Ã§ek
    async function loadAllQuestions() {
        try {
            const q = query(collection(db, QUESTIONS_COLLECTION));
            const snapshot = await getDocs(q);
            allQuestions = [];
            snapshot.forEach(doc => {
                allQuestions.push({ id: doc.id, ...doc.data() });
            });
        } catch (e) {
            console.error('Soru yÃ¼klenemedi:', e);
            allQuestions = SAMPLE_QUESTIONS.map((q, idx) => ({ id: `sample-${idx}`, ...q }));
        }
    }

    // Belirli seviye iÃ§in sorularÄ± rastgele seÃ§
    function loadLevelQuestions(level) {
        const countNeeded = getQuestionCountForLevel(level);
        const shuffled = [...allQuestions].sort(() => Math.random() - 0.5);
        currentLevelQuestions = shuffled.slice(0, countNeeded);
        gameState.currentQuestionIndexInLevel = Math.min(gameState.currentQuestionIndexInLevel, currentLevelQuestions.length - 1);
        if (gameState.currentQuestionIndexInLevel < 0) gameState.currentQuestionIndexInLevel = 0;
        loadQuestionAtIndex(gameState.currentQuestionIndexInLevel);
    }

    // Ä°ndexteki soruyu yÃ¼kle
    function loadQuestionAtIndex(index) {
        if (!currentLevelQuestions.length) return;
        currentQuestion = currentLevelQuestions[index];
        questionEl.innerText = currentQuestion.soru;
        optionsEl.innerHTML = '';
        currentQuestion.secenekler.forEach((sec, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = `<span style="font-weight:700; margin-right:8px;">${String.fromCharCode(65 + idx)}</span> ${sec}`;
            btn.dataset.optionIndex = idx;
            btn.addEventListener('click', () => handleOptionClick(idx, btn));
            optionsEl.appendChild(btn);
        });

        answered = false;
        firstAttempt = true;
        selectedOptionIndex = null;
        nextBtn.classList.add('disabled');
        nextBtn.classList.remove('active');
        document.querySelectorAll('.option-btn').forEach(b => {
            b.classList.remove('correct', 'wrong', 'disabled');
            b.disabled = false;
        });
    }

    // ÅžÄ±k tÄ±klama
    async function handleOptionClick(selectedIdx, btnElement) {
        if (!gameActive) return;
        if (answered) return;

        const isCorrect = (selectedIdx === currentQuestion.dogru);
        const questionId = `${gameState.currentLevel}_${currentQuestion.id || currentQuestion.soru}`;

        if (isCorrect) {
            answered = true;
            btnElement.classList.add('correct');
            document.querySelectorAll('.option-btn').forEach(b => b.classList.add('disabled'));

            // PUAN: sadece ilk denemede ve daha Ã¶nce puan alÄ±nmamÄ±ÅŸsa
            if (firstAttempt && !gameState.earnedPointsForQuestion[questionId]) {
                gameState.score += 1;
                gameState.earnedPointsForQuestion[questionId] = true;
                saveGameState();
                showToast('ðŸŽ‰ Harika! DoÄŸru cevap! +1 Puan', 'success');
                triggerConfetti();
            } else if (!firstAttempt) {
                showToast('âœ… DoÄŸru! (Ä°kinci denemede)', 'info');
            } else {
                showToast('âœ… DoÄŸru!', 'success');
            }

            nextBtn.classList.remove('disabled');
            nextBtn.classList.add('active');
        } else {
            // YANLIÅž
            btnElement.classList.add('wrong');
            btnElement.classList.add('disabled');
            btnElement.disabled = true;

            if (firstAttempt) {
                firstAttempt = false;
                showToast('âŒ YanlÄ±ÅŸ! Bir hakkÄ±n daha var.', 'info');
            } else {
                // Ä°kinci yanlÄ±ÅŸ: OYUN BÄ°TTÄ° - ama puan ve max seviye KORUNSUN
                gameActive = false;
                gameOverMessage.innerText = `Ä°kinci hakkÄ±nda da yanlÄ±ÅŸ cevap verdin.\nSeviye ${gameState.currentLevel}'e geri dÃ¶nÃ¼yorsun.`;
                gameOverModal.classList.add('active');
                document.querySelectorAll('.option-btn').forEach(b => b.classList.add('disabled'));
            }
        }
        scoreDisplay.innerText = gameState.score;
    }

    // Ä°leri butonuna tÄ±kla
    function onNext() {
        if (!nextBtn.classList.contains('active')) return;

        gameState.currentQuestionIndexInLevel++;
        if (gameState.currentQuestionIndexInLevel >= currentLevelQuestions.length) {
            // SEVÄ°YE TAMAMLANDI!
            const completedLevel = gameState.currentLevel;
            if (completedLevel === gameState.maxUnlockedLevel) {
                gameState.maxUnlockedLevel++;
            }
            gameState.currentLevel = completedLevel + 1;
            gameState.currentQuestionIndexInLevel = 0;
            saveGameState();
            loadLevelQuestions(gameState.currentLevel);
            currentLevelDisplay.innerText = gameState.currentLevel;
            renderLevelIndicators();
            showToast(`ðŸŽ¯ Seviye ${completedLevel} tamamlandÄ±! Seviye ${gameState.currentLevel} baÅŸladÄ±.`, 'success');
        } else {
            loadQuestionAtIndex(gameState.currentQuestionIndexInLevel);
            saveGameState();
        }
        nextBtn.classList.remove('active');
        nextBtn.classList.add('disabled');
    }

    // Oyun bittiÄŸinde "Seviyeyi Tekrarla" butonu:
    // Puan ve maxUnlockedLevel sÄ±fÄ±rlanmaz, sadece currentLevel'Ä± aynÄ± seviyede baÅŸa alÄ±r.
    function restartLevelAfterGameOver() {
        // Oyunun bittiÄŸi seviyeyi tekrar dene, soru indeksi 0 olsun.
        gameState.currentQuestionIndexInLevel = 0;
        gameActive = true;
        gameOverModal.classList.remove('active');
        loadLevelQuestions(gameState.currentLevel);
        currentLevelDisplay.innerText = gameState.currentLevel;
        // Puan ve maxUnlockedLevel aynen korunuyor, save'e gerek yok.
    }

    // ----------------------------------------------------
    // 6) INIT
    // ----------------------------------------------------
    window.addEventListener('DOMContentLoaded', async () => {
        loadGameState();
        await seedQuestionsIfNeeded();
        await loadAllQuestions();
        renderLevelIndicators();
        scoreDisplay.innerText = gameState.score;
        currentLevelDisplay.innerText = gameState.currentLevel;
        loadLevelQuestions(gameState.currentLevel);

        nextBtn.addEventListener('click', onNext);
        restartBtn.addEventListener('click', () => {
            restartLevelAfterGameOver();
        });
    });

</script>
</body>
</html>
